<!DOCTYPE html>
<html lang="ko">
<head>
@@include('@@webRoot/html/_include/app-head.html',{
"title": "Last Depth | 1st Depth"
})
<style>
    .test{position:relative;height:200px;}
    .canvas{position:absolute;left:0;}
</style>
</head>
<body>
    @@include('@@webRoot/html/_include/app-a11y.html')
    <div class="app">
        <!-- app-header //-->
        @@include('@@webRoot/html/_include/app-header.html',{
            'pageTit' :'페이지 타이틀'
        })
        <!-- // app-header -->

        <!-- app-container //-->
        <div class="app-container">
            <!-- app-lnb //-->
            <div class="app-lnb">
            </div>
            <!-- //app-lnb -->

            <!-- app-content // -->
            <main class="app-content">

                <section class="kb-sec">
                    <div class="test" id="js-container">
                        <div class="canvas"><canvas id="js-canvas" width:300px;height:200px;></canvas></div>
                        <div class="result">당첨결과</div>    
                    </div>
                </section>

            </main>
            <!-- // app-content -->

        </div>
        <!-- // app-container -->

        <!-- Layer (fullpage popup, modal, bottom sheet) // -->
        <div class="layered"> 
        </div>
        <!-- // Layer (fullpage popup, modal, bottom sheet) -->

    </div>
    <!-- Script -->
    @@include('@@webRoot/html/_include/common-js.html')
    <!-- Add Library (this page only)-->
    <script src="@@webRoot/static/js/ui.js"></script>
    <!-- Add Script -->
    
<script>
    (function() {
      
      'use strict';
      
      var isDrawing, lastPoint;
      var container    = document.getElementById('js-container'),
          canvas       = document.getElementById('js-canvas'),
          canvasWidth  = canvas.width,
          canvasHeight = canvas.height,
          ctx          = canvas.getContext('2d'),
          image        = new Image(),
          brush        = new Image();
          
      // base64 Workaround because Same-Origin-Policy
      image.src = '@@webRoot/static/images/_temp/reward-benefit01.png';
      image.onload = function() {
        ctx.drawImage(image, 0, 0);
        // Show the form when Image is loaded.
        document.querySelectorAll('.result')[0].style.visibility = 'visible';
      };
      brush.src = '@@webRoot/static/images/event/scarchimagetrans.png';
      
      canvas.addEventListener('mousedown', handleMouseDown, false);
      canvas.addEventListener('touchstart', handleMouseDown, false);
      canvas.addEventListener('mousemove', handleMouseMove, false);
      canvas.addEventListener('touchmove', handleMouseMove, false);
      canvas.addEventListener('mouseup', handleMouseUp, false);
      canvas.addEventListener('touchend', handleMouseUp, false);
      
      function distanceBetween(point1, point2) {
        return Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
      }
      
      function angleBetween(point1, point2) {
        return Math.atan2( point2.x - point1.x, point2.y - point1.y );
      }
      
      // Only test every `stride` pixel. `stride`x faster,
      // but might lead to inaccuracy
      function getFilledInPixels(stride) {
        if (!stride || stride < 1) { stride = 1; }
        
        var pixels   = ctx.getImageData(0, 0, canvasWidth, canvasHeight),
            pdata    = pixels.data,
            l        = pdata.length,
            total    = (l / stride),
            count    = 0;
        
        // Iterate over all pixels
        for(var i = count = 0; i < l; i += stride) {
          if (parseInt(pdata[i]) === 0) {
            count++;
          }
        }
        
        return Math.round((count / total) * 100);
      }
      
      function getMouse(e, canvas) {
        var offsetX = 0, offsetY = 0, mx, my;
    
        if (canvas.offsetParent !== undefined) {
          do {
            offsetX += canvas.offsetLeft;
            offsetY += canvas.offsetTop;
          } while ((canvas = canvas.offsetParent));
        }
    
        mx = (e.pageX || e.touches[0].clientX) - offsetX;
        my = (e.pageY || e.touches[0].clientY) - offsetY;
    
        return {x: mx, y: my};
      }
      
      function handlePercentage(filledInPixels) {
        filledInPixels = filledInPixels || 0;
        console.log(filledInPixels + '%');
        if (filledInPixels > 50) {
          // action 
          $('.canvas').hide();
          console.log('스크래치 부분 지우기')
        }
      }
      
      function handleMouseDown(e) {
        isDrawing = true;
        lastPoint = getMouse(e, canvas);
      }
    
      function handleMouseMove(e) {
        if (!isDrawing) { return; }
        
        e.preventDefault();
    
        var currentPoint = getMouse(e, canvas),
            dist = distanceBetween(lastPoint, currentPoint),
            angle = angleBetween(lastPoint, currentPoint),
            x, y;
        
        for (var i = 0; i < dist; i++) {
          x = lastPoint.x + (Math.sin(angle) * i) - 25;
          y = lastPoint.y + (Math.cos(angle) * i) - 25;
          ctx.globalCompositeOperation = 'destination-out';
          ctx.drawImage(brush, x, y);
        }
        
        lastPoint = currentPoint;
        handlePercentage(getFilledInPixels(32));
      }
    
      function handleMouseUp(e) {
        isDrawing = false;
      }
      
    })();
</script>

</body>
</html>

